extends layout

mixin topicRow(topic)
	tr
		td
			- if (topic.state === 'closed')
				i.icon-large.icon-check
			- else
				= topic.tally
		td
			a(href="/topics/#{topic.key}")= topic.title
		td= topic.proposedWhen()
		td
			- if (isOwner)
				form.form-inline(method="POST", action="/topics/#{topic.key}/close")
					button.btn.btn-large.btn-default(type="submit", value="close")
						i.icon-large.icon-check
						| &nbsp; Resolve

block content
	.page-header
		h2= agenda.title 
			br
			small &nbsp; run by #{agenda.owner_id}

	- if (!agenda.active)
		.alert.alert-warning
			| This agenda is no longer active.
	
	div!= description

	- var isOwner = locals.authed_user && (agenda.owner_id === locals.authed_user.email);
	- if (agenda.topics.length > 0)
		table.table
			tr
				td(colspan=4)
					h3 Open topics
			tr
				th Tally
				th Topic
				th Proposed
				th &nbsp;
			- each topic in agenda.topics.open
				+topicRow(topic)
			- if (agenda.topics.closed && agenda.topics.closed.length > 0)
				tr
					td(colspan=4)
						h3 Closed topics
				- each topic in agenda.topics.closed
					+topicRow(topic)

	- else
		p This meeting has no open topics.

	hr
	- if (locals.authed_user)
		p 
			- if (agenda.active)
				a.btn.btn-primary(href="/agendas/#{agenda.key}/topics/new") Add a topic &raquo;
				if (authed_user.email === agenda.owner_id)
					| &nbsp;
					form.form-inline(method="POST", action="/agendas/#{agenda.key}/close")
						button.btn.btn-danger(type="submit", value='close')
							i.icon-large.icon-archive 
							| Archive this agenda
			- else
				if (authed_user.email === agenda.owner_id)
					form.form-inline(method="POST", action="/agendas/#{agenda.key}/open")
						button.btn.btn-success(type="submit", value='open')
							i.icon-large.icon-archive 
							| Re-open this agenda

	- else
		p Log in to add topics or vote on proposals.
